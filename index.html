<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--<script src="https://junliaw.github.io/thunkable.github.io/thunkableWebviewerExtension.js" type="text/javascript"></script> -->
    <script>
      var ThunkableWebviewerExtension = (function () {
      const postMessageToWebview = (message) => {
        if (window.ReactNativeWebView) {
          window.ReactNativeWebView.postMessage(message);
        } else {
          window.parent.postMessage(message, '*');
        }
        };

      const getReceiveMessageCallback = (fxn, hasReturnValue) => (event) => {
      if (typeof fxn === 'function') {
      if (event.data) {
        let dataObject;
        try {
          dataObject = JSON.parse(event.data);
        } catch (e) {
          // message is not valid json
        }
        if (dataObject && dataObject.type === 'ThunkablePostMessage' && hasReturnValue) {
          fxn(dataObject.message, (returnValue) => {
            const returnMessageObject = { type: 'ThunkablePostMessageReturnValue', uuid: dataObject.uuid, returnValue };
            postMessageToWebview(JSON.stringify(returnMessageObject));
          });
        } else if (!hasReturnValue && (!dataObject || dataObject.type !== 'ThunkablePostMessage')) {
          fxn(event.data);
        }
      }
    }
  };

  return {
    postMessage: postMessageToWebview,
    receiveMessage: function(fxn) {
      const callbackFunction = getReceiveMessageCallback(fxn, false);
      document.addEventListener('message', callbackFunction, false);
      window.addEventListener('message', callbackFunction, false);
    },
    receiveMessageWithReturnValue: function(fxn) {
      const callbackFunction = getReceiveMessageCallback(fxn, true);
      document.addEventListener('message', callbackFunction, false);
      window.addEventListener('message', callbackFunction, false);
    },
  };
})();
    </script>
  </head>
  <body>
    <span id="messageDisplay"></span>
    <br />
    <button type="button" id="messageButton">Click to send a message to the app</button>
  </body>
  <script type="text/javascript">
    // when the button is clicked, send a message to the app
    document.getElementById('messageButton').onclick = function() {
      ThunkableWebviewerExtension.postMessage('hello world');
    }

    // when we get a message from the app, display it on the page
    ThunkableWebviewerExtension.receiveMessage(function(message) {
      document.getElementById('messageDisplay').innerHTML = message;
    });

    // when we get a message from the app that needs a return value
    // return the string 'fast response' unless the message is
    // 'slow message'. If the message is 'slow message', wait for
    // four seconds, then return the string 'slow response'.
    // The slow response shows how this could work for API calls that
    // take time to execute.
    ThunkableWebviewerExtension.receiveMessageWithReturnValue(function(message, callback) {
      if (message === 'slow message') {
        setTimeout(() => callback('slow response'), 4000);
      } else {
        callback('fast response');
      }
    });
  </script>
</html>
